<!--References:
http://bl.ocks.org/fabiomainardi/cf1233873ea5e7bc899b
https://blockbuilder.org/Catherine-Yu/535493a01252baa65cc69aed735088ae
-->

<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <meta charset="UTF-8">
    <title>Multiline Chart</title>
    <script src="//d3js.org/d3.v4.min.js"></script>
    <style>
        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
        }
    </style>
</head>
<body>
<svg width="960" height="500"></svg>
<script>

    var svg = d3.select("svg"),
        margin = {top: 100, right: 80, bottom: 40, left: 90},
        width = svg.attr("width") - margin.left - margin.right,
        height = svg.attr("height") - margin.top - margin.bottom - 20,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    //3 scales for different axes
    var x = d3.scaleLinear().range([0, width]),
        y = d3.scaleLinear().range([height, 0]),
        z = d3.scaleOrdinal(d3.schemeCategory10);

    var line = d3.line()
        .curve(d3.curveBasis)
        .x(function(d) {return x(+d.month); })
        .y(function(d) {
            return y(+d.numOfEarthquakes);
        });

    //setting all years true initially and making a dictionary
    var filtered={"2014":true,"2015":true,"2016":true,"2017":true,"2018":true,"2019":true,"2020":true};

    //mathod to draw the chart dependding on filtered data
    function drawChart(filterData) {
        d3.csv("monthyearcntml.csv", function (error, data) {
            if (error) throw error;

            //filtering the top state only which is California
            data = data.filter(function(d, i){
                if(d["place"] == "CA")
                    return data;
            })

            console.log("data: ",data)

            //preprocessing to generate format for plotting
            var modifiedData = {};
            data.forEach((i,k) => {
                var mapStateCount = {};
                if(!(i["year"] in modifiedData)){
                    mapStateCount["year"] = i["year"];
                    var values = [];
                    var monthcnt = {};
                    monthcnt["month"] = +i["month"];
                    monthcnt["numOfEarthquakes"] = +i["numOfEarthquakes"];
                    values.push(monthcnt);
                    mapStateCount["values"] = values;
                    var months = [];
                    months.push(+i["month"]);
                    mapStateCount["months"] = months;
                }
                else{
                    mapStateCount = modifiedData[i["year"]];
                    var values = mapStateCount["values"];
                    var monthcnt = {};
                    monthcnt["month"] = +i["month"];
                    monthcnt["numOfEarthquakes"] = +i["numOfEarthquakes"];
                    values.push(monthcnt);
                    mapStateCount["values"] = values;
                    var months = mapStateCount["months"];
                    months.push(+i["month"]);
                    mapStateCount["months"] = months;
                }
                modifiedData[i["year"]] = mapStateCount;
            });

            var years = Object.values(modifiedData);

            console.log("Final Data : ",years);

            //x axis domain - months
            x.domain([1,12]);

            //y axis domain - number of earthquakes minimum to maximum
            y.domain([
                d3.min(years, function (c) {
                    return d3.min(c.values, function (d) {
                        return d["numOfEarthquakes"];
                    });
                }),
                d3.max(years, function (c) {
                    return d3.max(c.values, function (d) {
                        return d["numOfEarthquakes"];
                    });
                })
            ]);

            // z axis i.e. selectable lines domain - year
            z.domain(years.map(function (c) {
                return c.year;
            }));

            g.selectAll("*").remove();

            // heading
            g.append("text")
                .attr("x", width/2)
                .attr("y", -50)
                .attr("text-anchor", "middle")
                .style("font-size", "20px")
                .text("Multiline chart of earthquakes in California from 2014-2020");

            // x axis and title
            g.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .append("text")
                .attr("fill", "#000")
                .attr("y",45)
                .attr("x",width/2)
                .attr("font-size","18px")
                .text("Months");

            //y axis and title
            g.append("g")
                .attr("class", "axis axis--y")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -65)
                .attr("x", -80)
                .attr("font-size","18px")
                .attr("dy", "0.71em")
                .attr("fill", "#000")
                .text("Number of earthquakes");

            // colour legend
            var legend = g.selectAll(".city")
                .data(years)
                .enter()
                .append("g")
                .attr("class", "legend");

            // rectangular legends according to year
            legend.append('rect')
                .attr('x', width - 20)
                .attr('y', function (d, i) {
                    return i * 20;
                })
                .attr('width', 10)
                .attr('height', 10)
                .style('fill', function (d) {
                    return z(d.year);
                });

            // adding labels to legend
            legend.append('text')
                .attr('x', width - 8)
                .attr('y', function (d, i) {
                    return (i * 20) + 9;
                })
                .text(function (d) {
                    return d.year;
                });

            // adding tooltip to legend
            legend
                .on("click", function (d) {
                    reDraw(d.year);
                })
                .on("mouseover", function(d){
                    select(d.year);
                })
                .on("mouseout", function(d){
                    deselect(d.year);
                });

            console.log("Check here :",years.filter(function(d){return filterData[d.year]==true;}));

            // getting the data for selected years
            var year = g.selectAll(".year")
                .data(years.filter(function(d){return filterData[d.year]==true;}))
                .enter().append("g")
                .attr("class", "year");

            // adding line for that year
            temp = year.append("path")
                .attr("class", function(d) {
                    console.log("year" + d.year);
                    return "line a"+ d.year;
                })
                .attr("d", function (d) {
                    return line(d.values);
                })
                .style("stroke", function (d) {
                    return z(d.year);
                });

            console.log("Temp : ",temp);

            //adding the text to show which line it is
            year.append("text")
                .datum(function (d) {
                    return {year: d.year, value: d.values[d.values.length - 1]};
                })
                .attr("transform", function (d) {
                    return "translate(" + x(d.value.month) + "," + y(d.value.numOfEarthquakes) + ")";
                })
                .attr("x", 3)
                .attr("dy", "0.35em")
                .style("font", "10px sans-serif")
                .text(function (d) {
                    return d.year;
                });
        });
    }

    drawChart(filtered);
    //redraw with the updated values
    function reDraw(year){
        filtered[year]=!filtered[year];
        console.log("Filtered data :");
        console.log(filtered);
        drawChart(filtered);
    }

    //select the year
    function select(year) {
        year = year.trim();
        console.log("Selceted year : ",year);
        let ID = "a2014";
        if(year === "2015"){
            ID="a2015";
        }
        else if(year === "2016"){
            ID="a2016";
        }
        else if(year === "2017"){
            ID="a2017";
        }
        else if(year === "2018"){
            ID="a2018";
        }
        else if(year === "2019"){
            ID="a2019";
        }
        else if(year === "2020"){
            ID="a2020";
        }
        d3.selectAll(".line")
            .transition().duration(150).style("stroke", "lightgrey")
            .style("opacity", "0.4")
        d3.selectAll("." + ID)
            .transition().duration(300)
            .style("stroke", z(year))
            .style("opacity", "1")
    }

    //unselect all the year
    function deselect() {
        d3.selectAll(".line")
            .transition().duration(150).delay(300)
            .style("stroke", function(d) {
                return (z(d.year))
            }).style("opacity", "1")
    }

</script>
<p>Source: <a href="https://www.usgs.gov/natural-hazards/earthquake-hazards/earthquakes">U.S.G.S.</a></p>
